{% extends "layout.html" %}
{% block content %}
<h1>Chat with Video: {{ video_name }}</h1>


{% if folder_list %}
  <ul>
    {% for folder in folder_list %}
      <li><strong>Back to the Channel:</strong>&nbsp;<a href="/chat-channel/{{ folder }}">{{ folder }}</a></li>
    {% endfor %}
  </ul>
{% else %}
  <p>No channels found for this video.</p>
{% endif %}

<details style="margin-bottom: 1em;">
    <summary><strong>Transcript</strong></summary>
    <div style="white-space: pre-wrap; margin-top: 0.5em; padding-left: 1em;">
      {{ video_transcript }}
    </div>
  </details>
  {% if summaries_by_type %}
    {% for stype, sumlist in summaries_by_type.items() %}
          {% for s in sumlist %}
            <details style="margin-bottom: 1em;">
              <summary>{{ stype|capitalize }} Summary (Model: {{ s.model_name }})</summary>
              <div style="white-space: pre-wrap; margin-top: 0.5em; padding-left: 1em;">
                {{ s.summary_text|safe }}
              </div>
            </details>
          {% endfor %}
        </div>
      
    {% endfor %}
  {% else %}
    <p>No summaries found.</p>
  {% endif %}

<div>
  <textarea id="userQuery" rows="3" cols="60" placeholder="Enter your question..."></textarea><br/>
  <button id="sendBtn">Send</button>
</div>
<div id="chatResult" style="margin-top:20px; border:1px solid #ccc; padding:10px;">
  <!-- Response from the server -->
</div>

<script>
document.getElementById('sendBtn').addEventListener('click', async () => {
const query = document.getElementById('userQuery').value.trim();
if (!query) return;

const chatDiv = document.getElementById('chatResult');
chatDiv.innerHTML = "Processing...";

try {
  const resp = await fetch(`/api/chat-video/{{ video_id }}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ query })
  });
  const data = await resp.json();
  chatDiv.innerHTML = data.answer;
} catch (err) {
  chatDiv.innerHTML = "Error: " + err;
}
});
</script>

{% endblock %}